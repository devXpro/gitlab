# GitLab Nginx Configuration for Cloudflare Setup with Self-Signed SSL
#
# This configuration uses self-signed SSL certificates for secure communication
# between Cloudflare and your server (Full Strict mode).
#
# Setup:
# 1. Generate self-signed certificate:
#    ./scripts/generate-self-signed-cert.sh
#
# 2. In Cloudflare DNS, create two A records (both with Proxy enabled - orange cloud):
#    - git.example.com -> YOUR_SERVER_IP
#    - registry.example.com -> YOUR_SERVER_IP
#
# 3. In Cloudflare SSL/TLS settings:
#    - Set SSL/TLS encryption mode to "Full (Strict)"
#    - Enable "Always Use HTTPS"
#
# 4. Copy this file to your server:
#    scp nginx/gitlab-cloudflare.conf root@YOUR_SERVER:/etc/nginx/sites-available/gitlab
#
# 5. Enable the site:
#    ln -s /etc/nginx/sites-available/gitlab /etc/nginx/sites-enabled/
#    nginx -t
#    systemctl reload nginx

# GitLab Web Interface - HTTP (redirect to HTTPS)
server {
    listen 80;
    listen [::]:80;
    server_name git.example.com;

    # Redirect all HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

# GitLab Web Interface - HTTPS
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name git.example.com;

    # SSL certificate (self-signed)
    ssl_certificate /etc/nginx/ssl/gitlab.crt;
    ssl_certificate_key /etc/nginx/ssl/gitlab.key;

    # SSL settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # Увеличенные таймауты для GitLab
    proxy_connect_timeout 300;
    proxy_send_timeout 300;
    proxy_read_timeout 300;
    send_timeout 300;
    
    # Увеличенный размер загружаемых файлов
    client_max_body_size 0;
    
    # Получаем реальный IP клиента от Cloudflare
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;
    set_real_ip_from 2a06:98c0::/29;
    set_real_ip_from 2c0f:f248::/32;
    real_ip_header CF-Connecting-IP;
    
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;  # Important! Tell GitLab that HTTPS is used
        proxy_set_header X-Forwarded-Ssl on;
        
        # WebSocket support
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}

# Container Registry - HTTP (redirect to HTTPS)
server {
    listen 80;
    listen [::]:80;
    server_name registry.example.com;

    # Redirect all HTTP to HTTPS
    return 301 https://$server_name$request_uri;
}

# Container Registry - HTTPS
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name registry.example.com;

    # SSL certificate (self-signed, same as GitLab)
    ssl_certificate /etc/nginx/ssl/gitlab.crt;
    ssl_certificate_key /etc/nginx/ssl/gitlab.key;

    # SSL settings
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    client_max_body_size 0;

    # Увеличенные таймауты
    proxy_connect_timeout 300;
    proxy_send_timeout 300;
    proxy_read_timeout 300;
    send_timeout 300;

    # Получаем реальный IP клиента от Cloudflare
    set_real_ip_from 173.245.48.0/20;
    set_real_ip_from 103.21.244.0/22;
    set_real_ip_from 103.22.200.0/22;
    set_real_ip_from 103.31.4.0/22;
    set_real_ip_from 141.101.64.0/18;
    set_real_ip_from 108.162.192.0/18;
    set_real_ip_from 190.93.240.0/20;
    set_real_ip_from 188.114.96.0/20;
    set_real_ip_from 197.234.240.0/22;
    set_real_ip_from 198.41.128.0/17;
    set_real_ip_from 162.158.0.0/15;
    set_real_ip_from 104.16.0.0/13;
    set_real_ip_from 104.24.0.0/14;
    set_real_ip_from 172.64.0.0/13;
    set_real_ip_from 131.0.72.0/22;
    set_real_ip_from 2400:cb00::/32;
    set_real_ip_from 2606:4700::/32;
    set_real_ip_from 2803:f800::/32;
    set_real_ip_from 2405:b500::/32;
    set_real_ip_from 2405:8100::/32;
    set_real_ip_from 2a06:98c0::/29;
    set_real_ip_from 2c0f:f248::/32;
    real_ip_header CF-Connecting-IP;

    location / {
        proxy_pass http://localhost:5050;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;  # Important! Tell Registry that HTTPS is used
    }
}

